<!DOCTYPE html>
<html lang="bn">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Student Portal | RASEL'S ICT ACADEMY</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
      <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
      <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

      <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            const firebaseConfig = {
                  apiKey: "AIzaSyBKFKKfNmmf9lvLdARZzL4WfSqqYeyN5P0",
                  authDomain: "rasel-ict-hub-61ce0.firebaseapp.com",
                  projectId: "rasel-ict-hub-61ce0",
                  storageBucket: "rasel-ict-hub-61ce0.firebasestorage.app",
                  messagingSenderId: "914822238317",
                  appId: "1:914822238317:web:f4fc09d89ca8bfd932af64",
                  measurementId: "G-H50N54TXN8"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth();
            const db = getFirestore(app);

            // --- Auth State Monitor ---
            onAuthStateChanged(auth, async (user) => {
                  if (user) {
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('dashboard-page').classList.remove('hidden');
                        await fetchStudentData(user.email);
                        initChapterNav();
                        setupRealTimeListeners(user.email);
                  } else {
                        document.getElementById('login-page').classList.remove('hidden');
                        document.getElementById('dashboard-page').classList.add('hidden');
                  }
            });

            async function fetchStudentData(email) {
                  const q = query(collection(db, "students"), where("email", "==", email));
                  const querySnapshot = await getDocs(q);
                  if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        document.getElementById('userName').innerText = data.name;
                        document.getElementById('userRoll').innerText = data.roll;
                        document.getElementById('userInitial').innerText = data.name.charAt(0).toUpperCase();
                  }
            }

            window.sendMessageToTeacher = async () => {
                  const msgText = document.getElementById('msg-to-teacher').value;
                  const studentName = document.getElementById('userName').innerText;
                  const studentRoll = document.getElementById('userRoll').innerText;
                  const toast = document.getElementById('toast');
                  const toastMsg = document.getElementById('toast-msg');

                  if (!msgText.trim()) return;

                  try {
                        await addDoc(collection(db, "messages"), {
                              studentName: studentName,
                              studentRoll: studentRoll,
                              studentEmail: auth.currentUser.email,
                              text: msgText,
                              timestamp: serverTimestamp()
                        });

                        document.getElementById('msg-to-teacher').value = "";
                        toastMsg.innerText = "‚úÖ Message Securely Transmitted!";
                        toast.classList.remove('hidden');
                        toast.classList.add('animate__fadeInDown');

                        setTimeout(() => {
                              toast.classList.replace('animate__fadeInDown', 'animate__fadeOutUp');
                              setTimeout(() => {
                                    toast.classList.add('hidden');
                                    toast.classList.remove('animate__fadeOutUp');
                              }, 500);
                        }, 3000);

                  } catch (e) {
                        toastMsg.innerText = "üö® Transmission Error!";
                        toast.classList.remove('hidden');
                  }
            };

            window.studentLogin = async () => {
                  const email = document.getElementById('sEmail').value;
                  const pass = document.getElementById('sPass').value;
                  const errorMsg = document.getElementById('error-msg');
                  const sadAnim = document.getElementById('sad-animation');
                  errorMsg.classList.add('hidden');
                  sadAnim.classList.add('hidden');

                  try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        confetti({
                              particleCount: 200,
                              spread: 100,
                              origin: { y: 0.6 },
                              colors: ['#0ea5e9', '#22c55e', '#ffffff', '#6366f1']
                        });
                  } catch (error) {
                        sadAnim.classList.remove('hidden');
                        errorMsg.innerText = "üö® Access Denied!";
                        errorMsg.classList.remove('hidden');
                  }
            };

            function initChapterNav() {
                  const nav = document.getElementById('chapter-nav');
                  nav.innerHTML = "";

                  const sections = [
                        { num: 1, title: "ICT: World & BD Perspective", desc: "Global and local impact" },
                        { num: 2, title: "Communication Systems & Networking", desc: "Networks & Internet" },
                        { num: 3, title: "Number Systems & Digital Devices", desc: "Binary, Logic Gates", isExpandable: true },
                        { num: 4, title: "Web Design & HTML", desc: "Basic web creation" },
                        { num: 5, title: "Programming Languages", desc: "C Fundamentals" },
                        { num: 6, title: "Database Management System", desc: "SQL Basics" },
                        { num: "M", id: "model-qa", title: "Model Questions & Answer", isSpecial: true }
                  ];

                  sections.forEach((sec) => {
                        if (sec.isExpandable) {
                              nav.innerHTML += `
                                <div class="mb-2">
                                    <button onclick="toggleSubMenu('ch3-sub')" class="w-full flex flex-col gap-1 px-5 py-4 rounded-2xl bg-sky-500/5 text-sky-400 border border-sky-500/20 text-left">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <span class="font-mono text-xs bg-sky-500/20 px-2 py-1 rounded">CH-03</span>
                                                <span class="font-bold text-sm leading-tight text-white">${sec.title}</span>
                                            </div>
                                            <span class="text-xs">‚ñº</span>
                                        </div>
                                    </button>
                                    <div id="ch3-sub" class="hidden pl-8 mt-2 space-y-2">
                                        <button onclick="loadChapterContent('3.1', 'Number Systems')" class="w-full p-2 text-xs text-left text-gray-400 hover:text-white">üîπ Part 1: Number Systems</button>
                                        <button onclick="loadChapterContent('3.2', 'Digital Devices')" class="w-full p-2 text-xs text-left text-gray-400 hover:text-white">üîπ Part 2: Digital Devices</button>
                                    </div>
                                </div>`;
                        } else {
                              const displayID = sec.isSpecial ? sec.num : `0${sec.num}`;
                              const targetID = sec.id || sec.num;
                              nav.innerHTML += `
                                <button onclick="loadChapterContent('${targetID}', '${sec.title}')" 
                                    class="w-full flex flex-col gap-1 px-5 py-4 rounded-2xl hover:bg-sky-500/10 text-gray-400 hover:text-sky-400 text-left border border-transparent hover:border-sky-500/20 mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="font-mono text-xs bg-sky-500/10 px-2 py-1 rounded">${displayID}</span>
                                        <span class="font-bold text-sm text-white">${sec.title}</span>
                                    </div>
                                </button>`;
                        }
                  });
            }

            window.loadChapterContent = async (chapterNum, title) => {
                  document.getElementById('current-chapter-title').innerText = `Chapter ${chapterNum}: ${title}`;
                  const container = document.getElementById('resource-container');
                  container.innerHTML = `<p class="text-gray-500 text-xs col-span-2 italic">Decrypting Resources...</p>`;

                  const q = query(collection(db, "resources"), where("chapter", "==", chapterNum.toString()));
                  const snapshot = await getDocs(q);
                  container.innerHTML = "";

                  if (snapshot.empty) {
                        container.innerHTML = `<div class="col-span-2 glass p-10 text-center text-gray-500 rounded-3xl italic">No files uploaded yet.</div>`;
                        return;
                  }

                  const iconMap = { 'PDF': 'üìÑ', 'PPT': 'üìä', 'NOTE': 'üìù', 'VIDEO': 'üìΩÔ∏è' };

                  snapshot.forEach(docSnap => {
                        const res = docSnap.data();
                        const icon = iconMap[res.type] || 'üìÅ';
                        container.innerHTML += `<div class="glass p-5 rounded-2xl border border-white/5 hover:border-sky-500/30 transition-all flex items-center justify-between">
                              <div class="flex items-center gap-4">
                                    <div class="h-12 w-12 bg-sky-500/10 rounded-xl flex items-center justify-center text-2xl">${icon}</div>
                                    <div>
                                          <h4 class="text-sm font-bold text-white">${res.title}</h4>
                                          <p class="text-[9px] text-gray-500 uppercase tracking-widest">${res.type} Resource</p>
                                    </div>
                              </div>
                              <a href="${res.link}" target="_blank" class="h-10 w-10 glass rounded-full flex items-center justify-center text-sky-500 hover:bg-sky-500 hover:text-white transition-all">‚¨áÔ∏è</a>
                        </div>`;
                  });
            };

            function setupRealTimeListeners(email) {
                  // ‡ßß. ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∏‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (Fixed)
                  onSnapshot(collection(db, "live_session"), (snap) => {
                        const sessionBox = document.getElementById('live-session-status');
                        if (!sessionBox) return;

                        if (!snap.empty) {
                              const link = snap.docs[0].data().url;
                              sessionBox.innerHTML = `
                                    <div class="animate__animated animate__pulse animate__infinite">
                                          <h3 class="text-xs font-black text-emerald-500 uppercase flex items-center gap-2">
                                                <span class="h-2 w-2 bg-emerald-500 rounded-full animate-ping"></span> Live Session is ON
                                          </h3>
                                          <a href="${link}" target="_blank" class="mt-2 inline-block bg-emerald-600 text-white px-6 py-2 rounded-xl text-[10px] font-black tracking-widest hover:bg-emerald-500 transition-all shadow-lg">JOIN NOW üì°</a>
                                    </div>
                                    <span class="text-3xl">üöÄ</span>`;
                        } else {
                              sessionBox.innerHTML = `
                                    <div>
                                          <h3 class="text-xs font-black text-gray-500 uppercase">Live Session</h3>
                                          <p class="text-[10px] text-gray-600 italic mt-1 font-medium">Status: Offline</p>
                                    </div>
                                    <span class="text-2xl opacity-20">üõ∞Ô∏è</span>`;
                        }
                  });

                  // ‡ß®. ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°
                  onSnapshot(collection(db, "notices"), (snap) => {
                        snap.forEach(doc => {
                              const noticeEl = document.getElementById('latest-notice');
                              if (noticeEl) noticeEl.innerText = doc.data().text;
                        });
                  });

                  // ‡ß©. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏
                  onSnapshot(query(collection(db, "attendance"), where("email", "==", email)), (snap) => {
                        const totalClasses = 30;
                        let presentCount = snap.size;
                        let percentage = (presentCount / totalClasses) * 100;
                        document.getElementById('att-percentage').innerText = Math.round(percentage) + "%";
                        document.getElementById('att-bar').style.width = percentage + "%";
                        document.getElementById('absent-count').innerText = (totalClasses - presentCount);
                  });
            }

            window.handleChat = () => {
                  const input = document.getElementById('chat-input');
                  const container = document.getElementById('chat-messages');
                  const userQuery = input.value.trim().toLowerCase();
                  if (!userQuery) return;
                  container.innerHTML += `<div class="flex justify-end"><div class="bg-sky-600 p-4 rounded-2xl max-w-[85%] text-white font-bold">${input.value}</div></div>`;
                  input.value = "";

                  const botResponse = "I am currently analyzing ICT topics. For direct help, message the teacher.";
                  setTimeout(() => {
                        container.innerHTML += `<div class="flex justify-start"><div class="bg-slate-800 p-4 rounded-2xl max-w-[85%] text-gray-200">${botResponse}</div></div>`;
                        container.scrollTop = container.scrollHeight;
                  }, 500);
            };

            window.toggleChat = () => {
                  const win = document.getElementById('chat-window');
                  win.classList.toggle('hidden');
            };

            window.toggleSubMenu = (id) => document.getElementById(id).classList.toggle('hidden');
            window.togglePass = () => {
                  const p = document.getElementById('sPass');
                  p.type = p.type === 'password' ? 'text' : 'password';
            };
            window.logout = () => signOut(auth);

            particlesJS("particles-js", {
                  "particles": {
                        "number": { "value": 60, "density": { "enable": true, "value_area": 800 } },
                        "color": { "value": "#0ea5e9" },
                        "opacity": { "value": 0.2 },
                        "size": { "value": 2 },
                        "line_linked": { "enable": true, "distance": 150, "color": "#0ea5e9", "opacity": 0.1, "width": 1 },
                        "move": { "enable": true, "speed": 2 }
                  }
            });
      </script>

      <style>
            @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap');

            body {
                  background: #020617;
                  color: white;
                  font-family: 'Rajdhani', sans-serif;
                  min-height: 100vh;
                  overflow-x: hidden;
            }

            #particles-js {
                  position: fixed;
                  width: 100%;
                  height: 100%;
                  z-index: 0;
            }

            .content-wrap {
                  position: relative;
                  z-index: 10;
                  padding: 2rem 1rem;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
            }

            .cyber-card {
                  background: rgba(15, 23, 42, 0.9);
                  backdrop-filter: blur(20px);
                  border: 1px solid rgba(14, 165, 233, 0.4);
                  border-radius: 40px;
                  width: 100%;
                  max-width: 420px;
            }

            .glow-input {
                  background: rgba(2, 6, 23, 0.7);
                  border: 1px solid #1e293b;
                  color: white;
                  outline: none;
                  transition: 0.3s;
            }

            .glow-input:focus {
                  border-color: #0ea5e9;
                  box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
            }

            .tech-font {
                  font-family: 'Orbitron', sans-serif;
            }

            .glass {
                  background: rgba(255, 255, 255, 0.03);
                  backdrop-filter: blur(12px);
                  border: 1px solid rgba(255, 255, 255, 0.1);
            }

            header.glass {
                  background: rgba(15, 23, 42, 0.95) !important;
                  position: sticky;
                  top: 0;
                  z-index: 100;
            }
      </style>
</head>

<body>
      <div id="particles-js"></div>
      <div class="content-wrap">
            <div id="login-page" class="w-full flex flex-col items-center animate__animated animate__fadeIn">
                  <div class="text-center mb-8">
                        <h1 class="text-3xl md:text-5xl font-bold tech-font text-white uppercase mb-2">RASEL'S <span
                                    class="text-sky-500">ICT</span> ACADEMY</h1>
                        <p class="text-gray-400 text-xs tracking-widest uppercase">Information Security Protocol</p>
                  </div>
                  <div class="cyber-card p-10">
                        <h2 class="text-xl font-bold tech-font text-sky-500 uppercase text-center mb-6">Login Portal
                        </h2>
                        <div id="sad-animation" class="hidden flex justify-center mb-4">
                              <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_tt96sqv6.json"
                                    speed="1" style="width: 80px; height: 80px;" loop autoplay></lottie-player>
                        </div>
                        <div class="space-y-4">
                              <input id="sEmail" type="email" placeholder="Student Email"
                                    class="w-full glow-input p-4 rounded-2xl">
                              <div class="relative">
                                    <input id="sPass" type="password" placeholder="Encryption Key"
                                          class="w-full glow-input p-4 rounded-2xl">
                                    <button onclick="togglePass()"
                                          class="absolute right-4 top-4 text-gray-500">üëÅÔ∏è</button>
                              </div>
                              <button onclick="studentLogin()"
                                    class="w-full bg-sky-600 hover:bg-sky-500 py-4 rounded-2xl tech-font font-bold transition-all shadow-lg shadow-sky-900/40">Authenticate
                                    _</button>
                              <div id="error-msg"
                                    class="hidden text-center text-red-400 text-xs font-bold p-3 bg-red-900/20 rounded-xl">
                              </div>
                        </div>
                  </div>
            </div>

            <div id="dashboard-page" class="hidden min-h-screen w-full animate__animated animate__fadeIn">
                  <div class="flex flex-col lg:flex-row h-screen">
                        <aside class="hidden lg:flex w-72 flex-col glass p-6 space-y-8 overflow-y-auto">
                              <h1 class="tech-font text-sky-500 font-bold text-center border-b border-white/5 pb-4">
                                    CURRICULUM</h1>
                              <div id="chapter-nav" class="space-y-1"></div>
                        </aside>

                        <div class="flex-1 flex flex-col h-full overflow-y-auto">
                              <header class="glass px-6 py-4 flex justify-between items-center shadow-2xl">
                                    <div class="flex items-center gap-4">
                                          <div class="h-12 w-12 bg-sky-500 rounded-xl flex items-center justify-center font-black text-xl text-white"
                                                id="userInitial">S</div>
                                          <div>
                                                <h2 class="text-lg font-black text-white uppercase" id="userName">
                                                      Student</h2>
                                                <span class="text-sky-400 font-mono text-xs" id="userRoll">ID:
                                                      #RA-0000</span>
                                          </div>
                                    </div>
                                    <button onclick="logout()"
                                          class="bg-red-600 px-4 py-2 rounded-xl text-white font-bold text-xs uppercase">Logout</button>
                              </header>

                              <main class="p-6 space-y-10 max-w-6xl mx-auto w-full">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                          <div class="glass p-6 rounded-[2rem] border-l-8 border-yellow-500">
                                                <h3 class="text-xs font-black text-yellow-500 uppercase mb-2">üì¢ Notice
                                                      Board</h3>
                                                <p id="latest-notice" class="text-sm italic text-gray-400">Loading
                                                      notices...</p>
                                          </div>
                                          <div id="live-session-status"
                                                class="glass p-6 rounded-[2rem] border-2 border-emerald-500/30 flex items-center justify-between min-h-[100px]">
                                                <div>
                                                      <h3 class="text-xs font-black text-emerald-500 uppercase">Live
                                                            Session</h3>
                                                      <p class="text-[10px] text-gray-500 italic">Offline</p>
                                                </div>
                                                <span class="text-2xl opacity-20">üõ∞Ô∏è</span>
                                          </div>
                                    </div>

                                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                                          <div class="xl:col-span-2 space-y-6">
                                                <h2 class="text-2xl font-bold uppercase border-b border-white/5 pb-2 inline-block"
                                                      id="current-chapter-title">Resources</h2>
                                                <div id="resource-container"
                                                      class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                          </div>

                                          <div class="space-y-6">
                                                <div
                                                      class="glass p-8 rounded-[2rem] text-center border-b-4 border-emerald-500">
                                                      <h4 class="text-gray-500 text-[10px] uppercase font-black mb-4">
                                                            Attendance</h4>
                                                      <div class="text-4xl font-black text-white mb-2"
                                                            id="att-percentage">0%</div>
                                                      <div
                                                            class="w-full bg-white/5 h-2 rounded-full overflow-hidden mb-2">
                                                            <div id="att-bar"
                                                                  class="bg-emerald-500 h-full transition-all duration-1000"
                                                                  style="width: 0%"></div>
                                                      </div>
                                                      <p class="text-[10px] text-gray-500">Absent: <span
                                                                  id="absent-count" class="text-red-500">--</span> Days
                                                      </p>
                                                </div>

                                                <div
                                                      class="glass p-6 rounded-[2rem] border-b-4 border-sky-500 space-y-4">
                                                      <h4
                                                            class="text-sky-500 text-[10px] font-black uppercase text-center">
                                                            Inquiry Box</h4>
                                                      <textarea id="msg-to-teacher" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                                                            class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs outline-none focus:border-sky-500 min-h-[100px]"></textarea>
                                                      <button onclick="sendMessageToTeacher()"
                                                            class="w-full bg-sky-600 py-3 rounded-xl font-bold text-xs uppercase">Send
                                                            Message</button>
                                                </div>
                                          </div>
                                    </div>
                              </main>
                        </div>
                  </div>
            </div>
      </div>

      <div id="chat-window"
            class="hidden fixed bottom-28 right-6 w-80 md:w-96 h-[450px] bg-[#0f172a] rounded-[2rem] border border-sky-500/40 shadow-2xl flex flex-col z-[1000] overflow-hidden">
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-sky-900/20">
                  <h4 class="text-sm font-black text-white">ICT AI BOT</h4>
                  <button onclick="toggleChat()" class="text-white text-xl">√ó</button>
            </div>
            <div id="chat-messages" class="flex-1 p-5 overflow-y-auto space-y-4 bg-[#020617]/50 scroll-smooth"></div>
            <div class="p-4 bg-[#0f172a] border-t border-white/10 flex gap-2">
                  <input id="chat-input" type="text" placeholder="Ask something..."
                        class="flex-1 bg-black/60 border border-white/10 rounded-xl px-4 py-3 text-sm text-white"
                        onkeypress="if(event.key === 'Enter') handleChat()">
                  <button onclick="handleChat()"
                        class="bg-sky-600 text-white px-5 rounded-xl font-black text-xs uppercase">SEND</button>
            </div>
      </div>

      <button onclick="toggleChat()"
            class="fixed bottom-10 right-10 h-14 w-14 bg-sky-500 rounded-2xl shadow-2xl flex items-center justify-center text-2xl z-50 animate-bounce">ü§ñ</button>

      <div id="toast"
            class="hidden fixed top-10 left-1/2 -translate-x-1/2 z-[100] glass px-8 py-4 rounded-2xl border-l-4 border-sky-500 text-white font-bold animate__animated">
            <p id="toast-msg"></p>
      </div>
</body>

</html>